steps:

  - commands: 
    - bundle install
    - RACK_ENV=test bundle exec rake db:drop
    - RACK_ENV=test bundle exec rake db:create
    - RACK_ENV=test bundle exec rake db:migrate
    - bundle exec rspec
    label: ":rspec:"
    artifact_paths:
      - coverage/*
  
  - wait

  - commands: 
    - "yarn install"
    - "tsc -p client --declaration false"
    label: ":typescript:"

  - wait
  
  - commands: 
    - "yarn install"
    - "yarn lint"
    label: ":eslint:"

  - wait
  
  - commands: 
    - "yarn install"
    - "yarn test --collectCoverage"
    label: ":jest:"

  - wait

  - name: ":codeclimate:"
    plugins:
      - jobready/codeclimate-test-reporter#v2.0:
          artifact: "coverage/.resultset.json"
          input_type: simplecov
          prefix: '/var/lib/buildkite-agent/builds/enterprise-oss-bk-1/enterpriseoss/osso/'

  - wait 

  - commands: 
      - "yarn install"
      - "yarn build"
      - "yarn cypress:ci"
    label: ":parcel: :cypress:"
    artifact_paths:
      - public/*
      - cypress/videos/*